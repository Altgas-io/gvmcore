COMPILER = solc

ASMSRC = ${wildcard *.asm}
SOLOUT = ${ASMSRC:.asm=.out}

all: ${TARGET}

${TARGET}: ${SOLOUT} Makefile
	@cat ${SOLOUT} | grep -A1 "Binary \representation:" | awk 'NR==2' > $@.bin

%.out: %.asm Makefile
	${COMPILER} --assemble $< > $@

run: run-evm

run-evm: ${TARGET}
	../../../ethereum/build/bin/evm --gas $(GASLIMIT) --code `cat ${TARGET}.bin` run

run-cemu: ${TARGET}
	../../../emulator/bins/cemu -nt ../../../emulator/models/evm/simulator/evm.so ${TARGET}.bin

compare: ${TARGET}
	../../../ethereum/build/bin/evm --gas $(GASLIMIT) --code `cat ${TARGET}.bin` run > out.evm.tmp
	@cat out.evm.tmp | awk '{print toupper($$0)}' > out.evm && rm out.evm.tmp
	../../../emulator/bins/cemu -nt ../../../emulator/models/evm/simulator/evm.so ${TARGET}.bin > out.cemu.tmp
	@cat out.cemu.tmp | awk '{print toupper($$0)}' > out.cemu && rm out.cemu.tmp
	@bash -c 'diff -q out.evm out.cemu 1>/dev/null; if [ $$? -eq 0 ]; then echo -e "$? is PASSED\n"; echo "PASS" >> ../passes; else echo -e "$? is FAILED\n"; echo "FAIL" >> ../fails;fi'

clean:
	rm -f ${TARGET}.bin ${SOLOUT} out.evm out.cemu
